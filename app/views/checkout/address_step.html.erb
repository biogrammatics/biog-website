<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8">
      <div class="checkout-progress mb-4">
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-primary" role="progressbar" style="width: 33%" aria-valuenow="33" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <small class="text-primary fw-bold">1. Address</small>
          <small class="text-muted">2. Payment</small>
          <small class="text-muted">3. Review</small>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Shipping & Billing Information</h4>
        </div>
        <div class="card-body">
          <%= form_with url: address_step_checkout_index_path, method: :post, local: true do |form| %>
            
            <!-- Billing Address Section -->
            <div class="mb-4">
              <h5 class="border-bottom pb-2 mb-3">Billing Address</h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[first_name]", "First Name", class: "form-label" %>
                  <%= form.text_field "billing_address[first_name]", 
                      value: @billing_address.first_name, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:first_name].any?}",
                      required: true %>
                  <% if @billing_address.errors[:first_name].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:first_name].first %></div>
                  <% end %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[last_name]", "Last Name", class: "form-label" %>
                  <%= form.text_field "billing_address[last_name]", 
                      value: @billing_address.last_name, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:last_name].any?}",
                      required: true %>
                  <% if @billing_address.errors[:last_name].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:last_name].first %></div>
                  <% end %>
                </div>
              </div>
              
              <div class="mb-3">
                <%= form.label "billing_address[company]", "Company (Optional)", class: "form-label" %>
                <%= form.text_field "billing_address[company]", 
                    value: @billing_address.company, 
                    class: "form-control" %>
              </div>
              
              <div class="mb-3">
                <%= form.label "billing_address[address_line_1]", "Address", class: "form-label" %>
                <%= form.text_field "billing_address[address_line_1]", 
                    value: @billing_address.address_line_1, 
                    class: "form-control #{'is-invalid' if @billing_address.errors[:address_line_1].any?}",
                    required: true %>
                <% if @billing_address.errors[:address_line_1].any? %>
                  <div class="invalid-feedback"><%= @billing_address.errors[:address_line_1].first %></div>
                <% end %>
              </div>
              
              <div class="mb-3">
                <%= form.label "billing_address[address_line_2]", "Address Line 2 (Optional)", class: "form-label" %>
                <%= form.text_field "billing_address[address_line_2]", 
                    value: @billing_address.address_line_2, 
                    class: "form-control" %>
              </div>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <%= form.label "billing_address[city]", "City", class: "form-label" %>
                  <%= form.text_field "billing_address[city]", 
                      value: @billing_address.city, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:city].any?}",
                      required: true %>
                  <% if @billing_address.errors[:city].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:city].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3">
                  <%= form.label "billing_address[state]", "State", class: "form-label" %>
                  <%= form.select "billing_address[state]", 
                      options_for_select([
                        ["Alabama", "AL"], ["Alaska", "AK"], ["Arizona", "AZ"], ["Arkansas", "AR"], ["California", "CA"],
                        ["Colorado", "CO"], ["Connecticut", "CT"], ["Delaware", "DE"], ["Florida", "FL"], ["Georgia", "GA"],
                        ["Hawaii", "HI"], ["Idaho", "ID"], ["Illinois", "IL"], ["Indiana", "IN"], ["Iowa", "IA"],
                        ["Kansas", "KS"], ["Kentucky", "KY"], ["Louisiana", "LA"], ["Maine", "ME"], ["Maryland", "MD"],
                        ["Massachusetts", "MA"], ["Michigan", "MI"], ["Minnesota", "MN"], ["Mississippi", "MS"], ["Missouri", "MO"],
                        ["Montana", "MT"], ["Nebraska", "NE"], ["Nevada", "NV"], ["New Hampshire", "NH"], ["New Jersey", "NJ"],
                        ["New Mexico", "NM"], ["New York", "NY"], ["North Carolina", "NC"], ["North Dakota", "ND"], ["Ohio", "OH"],
                        ["Oklahoma", "OK"], ["Oregon", "OR"], ["Pennsylvania", "PA"], ["Rhode Island", "RI"], ["South Carolina", "SC"],
                        ["South Dakota", "SD"], ["Tennessee", "TN"], ["Texas", "TX"], ["Utah", "UT"], ["Vermont", "VT"],
                        ["Virginia", "VA"], ["Washington", "WA"], ["West Virginia", "WV"], ["Wisconsin", "WI"], ["Wyoming", "WY"]
                      ], @billing_address.state), 
                      { prompt: "Select State" }, 
                      { class: "form-control #{'is-invalid' if @billing_address.errors[:state].any?}", required: true } %>
                  <% if @billing_address.errors[:state].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:state].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3">
                  <%= form.label "billing_address[postal_code]", "ZIP Code", class: "form-label" %>
                  <%= form.text_field "billing_address[postal_code]", 
                      value: @billing_address.postal_code, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:postal_code].any?}",
                      required: true %>
                  <% if @billing_address.errors[:postal_code].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:postal_code].first %></div>
                  <% end %>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[country]", "Country", class: "form-label" %>
                  <%= form.select "billing_address[country]", 
                      options_for_select([["United States", "United States"]], @billing_address.country || "United States"), 
                      {}, 
                      { class: "form-control", required: true } %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[phone]", "Phone Number", class: "form-label" %>
                  <%= form.telephone_field "billing_address[phone]", 
                      value: @billing_address.phone, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:phone].any?}",
                      required: true %>
                  <% if @billing_address.errors[:phone].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:phone].first %></div>
                  <% end %>
                </div>
              </div>
            </div>
            
            <!-- Use Billing for Shipping Checkbox -->
            <div class="mb-4">
              <div class="form-check">
                <%= form.check_box :use_billing_for_shipping, 
                    { checked: @use_billing_for_shipping, class: "form-check-input", id: "use_billing_for_shipping" } %>
                <%= form.label :use_billing_for_shipping, "Use billing address for shipping", class: "form-check-label" %>
              </div>
            </div>
            
            <!-- Shipping Address Section -->
            <div id="shipping-address-section" class="<%= 'collapse' if @use_billing_for_shipping %>">
              <h5 class="border-bottom pb-2 mb-3">Shipping Address</h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[first_name]", "First Name", class: "form-label" %>
                  <%= form.text_field "shipping_address[first_name]", 
                      value: @shipping_address.first_name, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:first_name].any?}" %>
                  <% if @shipping_address.errors[:first_name].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:first_name].first %></div>
                  <% end %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[last_name]", "Last Name", class: "form-label" %>
                  <%= form.text_field "shipping_address[last_name]", 
                      value: @shipping_address.last_name, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:last_name].any?}" %>
                  <% if @shipping_address.errors[:last_name].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:last_name].first %></div>
                  <% end %>
                </div>
              </div>
              
              <!-- Repeat similar fields for shipping address -->
              <div class="mb-3">
                <%= form.label "shipping_address[company]", "Company (Optional)", class: "form-label" %>
                <%= form.text_field "shipping_address[company]", 
                    value: @shipping_address.company, 
                    class: "form-control" %>
              </div>
              
              <div class="mb-3">
                <%= form.label "shipping_address[address_line_1]", "Address", class: "form-label" %>
                <%= form.text_field "shipping_address[address_line_1]", 
                    value: @shipping_address.address_line_1, 
                    class: "form-control #{'is-invalid' if @shipping_address.errors[:address_line_1].any?}" %>
                <% if @shipping_address.errors[:address_line_1].any? %>
                  <div class="invalid-feedback"><%= @shipping_address.errors[:address_line_1].first %></div>
                <% end %>
              </div>
              
              <div class="mb-3">
                <%= form.label "shipping_address[address_line_2]", "Address Line 2 (Optional)", class: "form-label" %>
                <%= form.text_field "shipping_address[address_line_2]", 
                    value: @shipping_address.address_line_2, 
                    class: "form-control" %>
              </div>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <%= form.label "shipping_address[city]", "City", class: "form-label" %>
                  <%= form.text_field "shipping_address[city]", 
                      value: @shipping_address.city, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:city].any?}" %>
                  <% if @shipping_address.errors[:city].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:city].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3">
                  <%= form.label "shipping_address[state]", "State", class: "form-label" %>
                  <%= form.select "shipping_address[state]", 
                      options_for_select([
                        ["Alabama", "AL"], ["Alaska", "AK"], ["Arizona", "AZ"], ["Arkansas", "AR"], ["California", "CA"],
                        ["Colorado", "CO"], ["Connecticut", "CT"], ["Delaware", "DE"], ["Florida", "FL"], ["Georgia", "GA"],
                        ["Hawaii", "HI"], ["Idaho", "ID"], ["Illinois", "IL"], ["Indiana", "IN"], ["Iowa", "IA"],
                        ["Kansas", "KS"], ["Kentucky", "KY"], ["Louisiana", "LA"], ["Maine", "ME"], ["Maryland", "MD"],
                        ["Massachusetts", "MA"], ["Michigan", "MI"], ["Minnesota", "MN"], ["Mississippi", "MS"], ["Missouri", "MO"],
                        ["Montana", "MT"], ["Nebraska", "NE"], ["Nevada", "NV"], ["New Hampshire", "NH"], ["New Jersey", "NJ"],
                        ["New Mexico", "NM"], ["New York", "NY"], ["North Carolina", "NC"], ["North Dakota", "ND"], ["Ohio", "OH"],
                        ["Oklahoma", "OK"], ["Oregon", "OR"], ["Pennsylvania", "PA"], ["Rhode Island", "RI"], ["South Carolina", "SC"],
                        ["South Dakota", "SD"], ["Tennessee", "TN"], ["Texas", "TX"], ["Utah", "UT"], ["Vermont", "VT"],
                        ["Virginia", "VA"], ["Washington", "WA"], ["West Virginia", "WV"], ["Wisconsin", "WI"], ["Wyoming", "WY"]
                      ], @shipping_address.state), 
                      { prompt: "Select State" }, 
                      { class: "form-control #{'is-invalid' if @shipping_address.errors[:state].any?}" } %>
                  <% if @shipping_address.errors[:state].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:state].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3">
                  <%= form.label "shipping_address[postal_code]", "ZIP Code", class: "form-label" %>
                  <%= form.text_field "shipping_address[postal_code]", 
                      value: @shipping_address.postal_code, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:postal_code].any?}" %>
                  <% if @shipping_address.errors[:postal_code].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:postal_code].first %></div>
                  <% end %>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[country]", "Country", class: "form-label" %>
                  <%= form.select "shipping_address[country]", 
                      options_for_select([["United States", "United States"]], @shipping_address.country || "United States"), 
                      {}, 
                      { class: "form-control" } %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[phone]", "Phone Number", class: "form-label" %>
                  <%= form.telephone_field "shipping_address[phone]", 
                      value: @shipping_address.phone, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:phone].any?}" %>
                  <% if @shipping_address.errors[:phone].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:phone].first %></div>
                  <% end %>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <%= link_to "Back to Cart", cart_path, class: "btn btn-outline-secondary" %>
              <%= form.submit "Continue to Payment", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <% @cart.cart_items.each do |cart_item| %>
            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-0"><%= cart_item.item_name %></h6>
                <small class="text-muted">Qty: <%= cart_item.quantity %></small>
              </div>
              <div class="text-end">
                <span class="fw-bold">$<%= cart_item.total_price %></span>
              </div>
            </div>
          <% end %>
          
          <div class="border-top pt-2 mt-3">
            <div class="d-flex justify-content-between">
              <span class="fw-bold">Subtotal:</span>
              <span class="fw-bold">$<%= @cart.total_price %></span>
            </div>
            <small class="text-muted">Shipping and tax calculated at next step</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkbox = document.getElementById('use_billing_for_shipping');
  const shippingSection = document.getElementById('shipping-address-section');
  
  checkbox.addEventListener('change', function() {
    if (this.checked) {
      shippingSection.classList.add('collapse');
    } else {
      shippingSection.classList.remove('collapse');
    }
  });
});
</script>