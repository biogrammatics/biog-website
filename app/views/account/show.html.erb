<div class="container mt-4">
  <div class="row">
    <div class="col-md-3">
      <div class="card">
        <div class="card-header">
          <h5>Account Menu</h5>
        </div>
        <div class="list-group list-group-flush">
          <a href="#overview" class="list-group-item list-group-item-action active">
            Overview
          </a>
          <a href="#subscriptions" class="list-group-item list-group-item-action">
            Subscriptions
          </a>
          <a href="#orders" class="list-group-item list-group-item-action">
            Order History
          </a>
          <a href="#custom-projects" class="list-group-item list-group-item-action">
            Custom Projects
          </a>
          <a href="#cart" class="list-group-item list-group-item-action">
            Shopping Cart
          </a>
          <a href="#profile" class="list-group-item list-group-item-action">
            Profile
          </a>
          <a href="#security" class="list-group-item list-group-item-action">
            Security
          </a>
        </div>
      </div>
    </div>
    
    <div class="col-md-9">
      <!-- Overview Section -->
      <div id="overview" class="mb-5">
        <div class="card">
          <div class="card-header">
            <h3>Account Overview</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h5>Welcome, <%= @user.full_name.presence || @user.email_address %>!</h5>
                <p class="text-muted">Here's a summary of your BioGrammatics account activity.</p>
              </div>
              <div class="col-md-6">
                <div class="row text-center">
                  <div class="col-3">
                    <h4 class="text-primary"><%= @subscriptions.count %></h4>
                    <p class="small text-muted">Subscriptions</p>
                  </div>
                  <div class="col-3">
                    <h4 class="text-warning"><%= @orders.count %></h4>
                    <p class="small text-muted">Orders</p>
                  </div>
                  <div class="col-3">
                    <h4 class="text-success"><%= @custom_projects.count %></h4>
                    <p class="small text-muted">Custom Projects</p>
                  </div>
                  <div class="col-3">
                    <h4 class="text-info"><%= @cart_items.count %></h4>
                    <p class="small text-muted">Cart Items</p>
                  </div>
                </div>
              </div>
            </div>
            
            <% if @current_subscription %>
              <div class="alert alert-success" role="alert">
                <strong>Active Twist Subscription</strong><br>
                You have an active subscription with <%= @current_subscription.vectors.count %> vectors.
                Renewal date: <%= @current_subscription.renewal_date.strftime("%B %d, %Y") %>
              </div>
            <% else %>
              <div class="alert alert-info" role="alert">
                <strong>Start a Twist Subscription</strong><br>
                Subscribe to our vectors for seamless DNA synthesis through Twist Bioscience.
                <%= link_to "Learn More", subscriptions_path, class: "alert-link" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Subscriptions Section -->
      <div id="subscriptions" class="mb-5">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Your Subscriptions</h3>
            <% unless @current_subscription %>
              <%= link_to "Start Subscription", new_subscription_path, class: "btn btn-primary btn-sm" %>
            <% end %>
          </div>
          <div class="card-body">
            <% if @subscriptions.any? %>
              <% @subscriptions.each do |subscription| %>
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h5>
                          Twist Subscription
                          <span class="badge <%= subscription.active? ? 'bg-success' : 'bg-warning' %>">
                            <%= subscription.status.titleize %>
                          </span>
                        </h5>
                        <p class="text-muted mb-1">
                          <strong>Twist Username:</strong> <%= subscription.twist_username %>
                        </p>
                        <p class="text-muted mb-1">
                          <strong>Vectors:</strong> <%= subscription.vectors.count %>
                        </p>
                        <% if subscription.renewal_date %>
                          <p class="text-muted mb-0">
                            <strong>Renewal:</strong> <%= subscription.renewal_date.strftime("%b %d, %Y") %>
                          </p>
                        <% end %>
                      </div>
                      <div class="text-end">
                        <h5 class="text-primary">$<%= (subscription.onboarding_fee + subscription.total_subscription_cost).round(2) %></h5>
                        <%= link_to "Manage", subscription, class: "btn btn-outline-primary btn-sm" %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-5">
                <i class="fas fa-dna fa-3x text-muted mb-3"></i>
                <h4>No Subscriptions Yet</h4>
                <p class="text-muted">Start a Twist subscription to access our vector library.</p>
                <%= link_to "Browse Vectors", subscriptions_path, class: "btn btn-primary" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Order History Section -->
      <div id="orders" class="mb-5">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Order History</h3>
            <%= link_to "Continue Shopping", vectors_path, class: "btn btn-primary btn-sm" %>
          </div>
          <div class="card-body">
            <% if @orders.any? %>
              <% @orders.each do |order| %>
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h5>
                          Order #<%= order.order_number %>
                          <span class="badge <%= case order.status
                            when 'pending' then 'bg-warning text-dark'
                            when 'processing' then 'bg-info'
                            when 'shipped' then 'bg-primary'
                            when 'delivered' then 'bg-success'
                            when 'cancelled' then 'bg-danger'
                            else 'bg-secondary'
                          end %> ms-2">
                            <%= order.display_status %>
                          </span>
                        </h5>
                        <div class="row">
                          <div class="col-md-6">
                            <p class="text-muted mb-1">
                              <strong>Order Date:</strong> <%= order.ordered_at.strftime("%b %d, %Y at %I:%M %p") %>
                            </p>
                            <p class="text-muted mb-1">
                              <strong>Items:</strong> <%= pluralize(order.order_items.sum(:quantity), 'item') %>
                            </p>
                            <% if order.shipping_address.present? %>
                              <p class="text-muted mb-0">
                                <strong>Ship to:</strong> <%= order.shipping_address.split("\n").first %>
                              </p>
                            <% end %>
                          </div>
                          <div class="col-md-6">
                            <div class="text-end">
                              <h5 class="text-primary mb-2">$<%= sprintf("%.2f", order.total_amount) %></h5>
                              <% if order.status == 'shipped' && order.tracking_number %>
                                <p class="text-muted mb-1">
                                  <strong>Tracking:</strong> <%= order.tracking_number %>
                                </p>
                              <% end %>
                            </div>
                          </div>
                        </div>
                        
                        <!-- Order Items -->
                        <div class="mt-3">
                          <h6 class="border-bottom pb-1 mb-2">Items Ordered:</h6>
                          <% order.order_items.each do |item| %>
                            <div class="d-flex justify-content-between align-items-center py-1">
                              <div>
                                <span class="fw-bold"><%= item.item_name %></span>
                                <% if item.item_description.present? %>
                                  <br><small class="text-muted"><%= item.item_description %></small>
                                <% end %>
                              </div>
                              <div class="text-end">
                                <span>Qty: <%= item.quantity %> Ã— $<%= item.price %> = $<%= item.total_price %></span>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-5">
                <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                <h4>No Orders Yet</h4>
                <p class="text-muted">When you place orders, they'll appear here.</p>
                <div>
                  <%= link_to "Browse Vectors", vectors_path, class: "btn btn-primary me-2" %>
                  <%= link_to "Browse Strains", pichia_strains_path, class: "btn btn-primary" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Custom Projects Section -->
      <div id="custom-projects" class="mb-5">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Your Custom Projects</h3>
            <%= link_to "Start New Project", new_custom_project_path, class: "btn btn-success btn-sm" %>
          </div>
          <div class="card-body">
            <% if @custom_projects.any? %>
              <% @custom_projects.each do |project| %>
                <div class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h5>
                          <%= link_to project.project_name, custom_project_path(project), class: "text-decoration-none" %>
                          <% case project.status %>
                          <% when 'pending' %>
                            <span class="badge bg-warning text-dark ms-2"><%= project.display_status %></span>
                          <% when 'in_progress' %>
                            <span class="badge bg-primary ms-2"><%= project.display_status %></span>
                          <% when 'completed' %>
                            <span class="badge bg-success ms-2"><%= project.display_status %></span>
                          <% when 'cancelled' %>
                            <span class="badge bg-danger ms-2"><%= project.display_status %></span>
                          <% else %>
                            <span class="badge bg-secondary ms-2"><%= project.display_status %></span>
                          <% end %>
                        </h5>
                        <% if project.project_type.present? %>
                          <p class="text-muted mb-1">
                            <strong>Type:</strong> <%= project.project_type.humanize %>
                          </p>
                        <% end %>
                        <% if project.total_services.any? %>
                          <p class="text-muted mb-1">
                            <strong>Services:</strong> <%= project.total_services.join(", ") %>
                          </p>
                        <% end %>
                        <p class="text-muted mb-0">
                          <strong>Submitted:</strong> <%= project.created_at.strftime("%b %d, %Y") %>
                        </p>
                        <% if project.estimated_cost.present? %>
                          <p class="text-muted mb-0">
                            <strong>Estimated Cost:</strong> $<%= number_with_precision(project.estimated_cost, precision: 2) %>
                          </p>
                        <% end %>
                        <% if project.estimated_completion_date.present? %>
                          <p class="text-muted mb-0">
                            <strong>Expected Completion:</strong> <%= project.estimated_completion_date.strftime("%b %d, %Y") %>
                          </p>
                        <% end %>
                      </div>
                      <div class="text-end ms-3">
                        <%= link_to "View Details", custom_project_path(project), class: "btn btn-outline-primary btn-sm d-block mb-2" %>
                        <% if project.status == 'pending' || project.status == 'cancelled' %>
                          <%= link_to "Edit", edit_custom_project_path(project), class: "btn btn-outline-secondary btn-sm d-block" %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-5">
                <i class="bi bi-gear-fill fs-1 text-muted mb-3"></i>
                <h4>No Custom Projects Yet</h4>
                <p class="text-muted">Start a custom project for tailored Pichia pastoris solutions.</p>
                <%= link_to "Start Your First Project", new_custom_project_path, class: "btn btn-success" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Shopping Cart Section -->
      <div id="cart" class="mb-5">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Shopping Cart</h3>
            <%= link_to "View Full Cart", cart_path, class: "btn btn-outline-primary btn-sm" %>
          </div>
          <div class="card-body">
            <% if @cart_items.any? %>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Type</th>
                      <th>Quantity</th>
                      <th>Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% @cart_items.each do |cart_item| %>
                      <tr>
                        <td><%= cart_item.item_name %></td>
                        <td><%= cart_item.item_type %></td>
                        <td><%= cart_item.quantity %></td>
                        <td>$<%= cart_item.total_price %></td>
                      </tr>
                    <% end %>
                  </tbody>
                  <tfoot>
                    <tr class="table-info">
                      <th colspan="3">Total</th>
                      <th>$<%= @user.current_cart.total_price %></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            <% else %>
              <div class="text-center py-4">
                <p class="text-muted">Your cart is empty.</p>
                <div>
                  <%= link_to "Browse Vectors", vectors_path, class: "btn btn-primary btn-sm me-2" %>
                  <%= link_to "Browse Strains", pichia_strains_path, class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Profile Section -->
      <div id="profile" class="mb-5">
        <div class="card">
          <div class="card-header">
            <h3>Profile Information</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <p><strong>Email:</strong> <%= @user.email_address %></p>
                <p><strong>First Name:</strong> <%= @user.first_name || "Not provided" %></p>
                <p><strong>Last Name:</strong> <%= @user.last_name || "Not provided" %></p>
                <% if @user.twist_username %>
                  <p><strong>Twist Username:</strong> <%= @user.twist_username %></p>
                <% end %>
              </div>
              <div class="col-md-6">
                <p><strong>Account Type:</strong> 
                  <span class="badge <%= @user.admin? ? 'bg-danger' : 'bg-success' %>">
                    <%= @user.admin? ? 'Administrator' : 'Customer' %>
                  </span>
                </p>
                <p><strong>Member Since:</strong> <%= @user.created_at.strftime("%B %Y") %></p>
              </div>
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between">
              <div>
                <button class="btn btn-outline-secondary" disabled>
                  Edit Profile
                  <small class="d-block">Coming Soon</small>
                </button>
              </div>
              <div>
                <%= button_to "Sign Out", session_path, method: :delete, class: "btn btn-outline-danger" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Section -->
      <div id="security" class="mb-5">
        <div class="card">
          <div class="card-header">
            <h3>Security Settings</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-12">
                <h5>Two-Factor Authentication</h5>
                <% if @user.two_factor_enabled? %>
                  <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <div>
                      <i class="fas fa-shield-alt me-2"></i>
                      <strong>Two-factor authentication is enabled</strong>
                      <p class="mb-0 mt-1 text-sm">
                        Method: <%= @user.otp_delivery_method == 'totp' ? 'Authenticator App' : 'SMS to ' + @user.phone_number.gsub(/(\d{3})(\d{3})(\d{4})/, '(\\1) \\2-\\3') %>
                      </p>
                    </div>
                    <%= link_to "Manage 2FA Settings", two_factor_setup_path, class: "btn btn-outline-success btn-sm" %>
                  </div>
                <% else %>
                  <div class="alert alert-warning d-flex justify-content-between align-items-center">
                    <div>
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>Two-factor authentication is not enabled</strong>
                      <p class="mb-0 mt-1">
                        <% if @user.admin? %>
                          <span class="text-danger">As an administrator, you are required to enable 2FA.</span>
                        <% else %>
                          Add an extra layer of security to your account.
                        <% end %>
                      </p>
                    </div>
                    <%= link_to "Enable 2FA", two_factor_setup_path, class: "btn btn-warning btn-sm text-dark" %>
                  </div>
                <% end %>

                <hr>

                <h5>Password</h5>
                <p class="text-muted">Keep your account secure with a strong, unique password.</p>
                <%= link_to "Change Password", new_password_path, class: "btn btn-outline-secondary" %>

                <hr>

                <h5>Active Sessions</h5>
                <p class="text-muted">
                  You are currently signed in on <%= pluralize(@user.sessions.count, 'device') %>.
                </p>
                <% if @user.sessions.count > 1 %>
                  <button class="btn btn-outline-danger btn-sm" disabled>
                    Sign out other devices
                    <small class="d-block">Coming Soon</small>
                  </button>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Saved Addresses -->
      <div class="card mt-4">
        <div class="card-header">
          <h3>Saved Addresses</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h5>Default Billing Address</h5>
              <% if @billing_address %>
                <div class="p-3 bg-light rounded mb-3">
                  <strong><%= @billing_address.full_name %></strong><br>
                  <% if @billing_address.company.present? %>
                    <%= @billing_address.company %><br>
                  <% end %>
                  <%= @billing_address.address_line_1 %><br>
                  <% if @billing_address.address_line_2.present? %>
                    <%= @billing_address.address_line_2 %><br>
                  <% end %>
                  <%= @billing_address.city %>, <%= @billing_address.state %> <%= @billing_address.postal_code %><br>
                  <%= @billing_address.country %><br>
                  <small class="text-muted">Phone: <%= @billing_address.phone %></small>
                </div>
              <% else %>
                <p class="text-muted">No default billing address saved. It will be added during your next checkout.</p>
              <% end %>
            </div>
            
            <div class="col-md-6">
              <h5>Default Shipping Address</h5>
              <% if @shipping_address %>
                <div class="p-3 bg-light rounded mb-3">
                  <strong><%= @shipping_address.full_name %></strong><br>
                  <% if @shipping_address.company.present? %>
                    <%= @shipping_address.company %><br>
                  <% end %>
                  <%= @shipping_address.address_line_1 %><br>
                  <% if @shipping_address.address_line_2.present? %>
                    <%= @shipping_address.address_line_2 %><br>
                  <% end %>
                  <%= @shipping_address.city %>, <%= @shipping_address.state %> <%= @shipping_address.postal_code %><br>
                  <%= @shipping_address.country %><br>
                  <small class="text-muted">Phone: <%= @shipping_address.phone %></small>
                </div>
              <% else %>
                <p class="text-muted">No default shipping address saved. It will be added during your next checkout.</p>
              <% end %>
            </div>
          </div>
          
          <% if @saved_addresses.any? %>
            <hr>
            <h5>All Saved Addresses (<%= @saved_addresses.count %>)</h5>
            <div class="text-muted">
              <small>Your addresses are automatically saved during checkout and used to prefill forms for faster ordering.</small>
            </div>
          <% end %>
        </div>
      </div>
      <!-- End Saved Addresses -->
    </div>
  </div>
</div>

<script>
  // Simple anchor navigation for account sections
  document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('.list-group-item-action');
    links.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove active class from all links
        links.forEach(l => l.classList.remove('active'));
        
        // Add active class to clicked link
        this.classList.add('active');
        
        // Scroll to section (optional smooth behavior)
        const targetId = this.getAttribute('href');
        if (targetId && targetId !== '#') {
          const target = document.querySelector(targetId);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
    });
  });
</script>
