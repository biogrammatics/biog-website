<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8">
      <div class="checkout-progress mb-4">
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-primary" role="progressbar" style="width: 33%" aria-valuenow="33" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <small class="text-primary fw-bold">1. Address</small>
          <small class="text-muted">2. Payment</small>
          <small class="text-muted">3. Review</small>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Shipping & Billing Information</h4>
        </div>
        <div class="card-body">
          <%= form_with url: address_step_checkout_index_path, method: :post, local: true do |form| %>
            
            <!-- Billing Address Section -->
            <div class="mb-4">
              <h5 class="border-bottom pb-2 mb-3">Billing Address</h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[first_name]", "First Name", class: "form-label" %>
                  <%= form.text_field "billing_address[first_name]", 
                      value: @billing_address.first_name, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:first_name].any?}",
                      required: true %>
                  <% if @billing_address.errors[:first_name].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:first_name].first %></div>
                  <% end %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[last_name]", "Last Name", class: "form-label" %>
                  <%= form.text_field "billing_address[last_name]", 
                      value: @billing_address.last_name, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:last_name].any?}",
                      required: true %>
                  <% if @billing_address.errors[:last_name].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:last_name].first %></div>
                  <% end %>
                </div>
              </div>
              
              <div class="mb-3">
                <%= form.label "billing_address[company]", "Company (Optional)", class: "form-label" %>
                <%= form.text_field "billing_address[company]", 
                    value: @billing_address.company, 
                    class: "form-control" %>
              </div>
              
              <div class="mb-3">
                <%= form.label "billing_address[address_line_1]", "Address", class: "form-label" %>
                <%= form.text_field "billing_address[address_line_1]", 
                    value: @billing_address.address_line_1, 
                    class: "form-control #{'is-invalid' if @billing_address.errors[:address_line_1].any?}",
                    required: true %>
                <% if @billing_address.errors[:address_line_1].any? %>
                  <div class="invalid-feedback"><%= @billing_address.errors[:address_line_1].first %></div>
                <% end %>
              </div>
              
              <div class="mb-3">
                <%= form.label "billing_address[address_line_2]", "Address Line 2 (Optional)", class: "form-label" %>
                <%= form.text_field "billing_address[address_line_2]", 
                    value: @billing_address.address_line_2, 
                    class: "form-control" %>
              </div>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <%= form.label "billing_address[city]", "City", class: "form-label" %>
                  <%= form.text_field "billing_address[city]", 
                      value: @billing_address.city, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:city].any?}",
                      required: true %>
                  <% if @billing_address.errors[:city].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:city].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3" id="billing-state-container">
                  <%= form.label "billing_address[state]", "State/Province/Region", class: "form-label", id: "billing-state-label" %>
                  <div id="billing-state-select-container">
                    <% if @billing_address.country == "Canada" %>
                      <%= form.select "billing_address[state]", 
                          options_for_select(canadian_provinces_for_select, @billing_address.state),
                          { prompt: "Select Province" }, 
                          { class: "form-control #{'is-invalid' if @billing_address.errors[:state].any?}", id: "billing_state" } %>
                    <% elsif @billing_address.country == "United States" || @billing_address.country.blank? %>
                      <%= form.select "billing_address[state]", 
                          options_for_select(us_states_for_select, @billing_address.state),
                          { prompt: "Select State" }, 
                          { class: "form-control #{'is-invalid' if @billing_address.errors[:state].any?}", id: "billing_state" } %>
                    <% else %>
                      <%= form.text_field "billing_address[state]", 
                          value: @billing_address.state,
                          placeholder: "State/Province/Region",
                          class: "form-control #{'is-invalid' if @billing_address.errors[:state].any?}",
                          id: "billing_state" %>
                    <% end %>
                  </div>
                  <% if @billing_address.errors[:state].any? %>
                    <div class="invalid-feedback d-block"><%= @billing_address.errors[:state].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3">
                  <%= form.label "billing_address[postal_code]", "ZIP/Postal Code", class: "form-label", id: "billing-postal-label" %>
                  <%= form.text_field "billing_address[postal_code]", 
                      value: @billing_address.postal_code, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:postal_code].any?}",
                      required: true %>
                  <% if @billing_address.errors[:postal_code].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:postal_code].first %></div>
                  <% end %>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[country]", "Country", class: "form-label" %>
                  <%= form.select "billing_address[country]", 
                      grouped_options_for_select(countries_for_select, @billing_address.country || "United States"), 
                      {}, 
                      { class: "form-control", required: true, id: "billing_country" } %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "billing_address[phone]", "Phone Number", class: "form-label" %>
                  <%= form.telephone_field "billing_address[phone]", 
                      value: @billing_address.phone, 
                      class: "form-control #{'is-invalid' if @billing_address.errors[:phone].any?}",
                      placeholder: "+1 (555) 123-4567",
                      required: true %>
                  <% if @billing_address.errors[:phone].any? %>
                    <div class="invalid-feedback"><%= @billing_address.errors[:phone].first %></div>
                  <% end %>
                  <small class="form-text text-muted">Include country code for international numbers</small>
                </div>
              </div>
            </div>
            
            <!-- Use Billing for Shipping Checkbox -->
            <div class="mb-4">
              <div class="form-check">
                <%= form.check_box :use_billing_for_shipping, 
                    { checked: @use_billing_for_shipping, class: "form-check-input", id: "use_billing_for_shipping" } %>
                <%= form.label :use_billing_for_shipping, "Use billing address for shipping", class: "form-check-label" %>
              </div>
            </div>
            
            <!-- Shipping Address Section -->
            <div id="shipping-address-section" class="<%= 'collapse' if @use_billing_for_shipping %>">
              <h5 class="border-bottom pb-2 mb-3">Shipping Address</h5>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[first_name]", "First Name", class: "form-label" %>
                  <%= form.text_field "shipping_address[first_name]", 
                      value: @shipping_address.first_name, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:first_name].any?}" %>
                  <% if @shipping_address.errors[:first_name].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:first_name].first %></div>
                  <% end %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[last_name]", "Last Name", class: "form-label" %>
                  <%= form.text_field "shipping_address[last_name]", 
                      value: @shipping_address.last_name, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:last_name].any?}" %>
                  <% if @shipping_address.errors[:last_name].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:last_name].first %></div>
                  <% end %>
                </div>
              </div>
              
              <!-- Repeat similar fields for shipping address -->
              <div class="mb-3">
                <%= form.label "shipping_address[company]", "Company (Optional)", class: "form-label" %>
                <%= form.text_field "shipping_address[company]", 
                    value: @shipping_address.company, 
                    class: "form-control" %>
              </div>
              
              <div class="mb-3">
                <%= form.label "shipping_address[address_line_1]", "Address", class: "form-label" %>
                <%= form.text_field "shipping_address[address_line_1]", 
                    value: @shipping_address.address_line_1, 
                    class: "form-control #{'is-invalid' if @shipping_address.errors[:address_line_1].any?}" %>
                <% if @shipping_address.errors[:address_line_1].any? %>
                  <div class="invalid-feedback"><%= @shipping_address.errors[:address_line_1].first %></div>
                <% end %>
              </div>
              
              <div class="mb-3">
                <%= form.label "shipping_address[address_line_2]", "Address Line 2 (Optional)", class: "form-label" %>
                <%= form.text_field "shipping_address[address_line_2]", 
                    value: @shipping_address.address_line_2, 
                    class: "form-control" %>
              </div>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <%= form.label "shipping_address[city]", "City", class: "form-label" %>
                  <%= form.text_field "shipping_address[city]", 
                      value: @shipping_address.city, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:city].any?}" %>
                  <% if @shipping_address.errors[:city].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:city].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3" id="shipping-state-container">
                  <%= form.label "shipping_address[state]", "State/Province/Region", class: "form-label", id: "shipping-state-label" %>
                  <div id="shipping-state-select-container">
                    <% if @shipping_address.country == "Canada" %>
                      <%= form.select "shipping_address[state]", 
                          options_for_select(canadian_provinces_for_select, @shipping_address.state),
                          { prompt: "Select Province" }, 
                          { class: "form-control #{'is-invalid' if @shipping_address.errors[:state].any?}", id: "shipping_state" } %>
                    <% elsif @shipping_address.country == "United States" || @shipping_address.country.blank? %>
                      <%= form.select "shipping_address[state]", 
                          options_for_select(us_states_for_select, @shipping_address.state),
                          { prompt: "Select State" }, 
                          { class: "form-control #{'is-invalid' if @shipping_address.errors[:state].any?}", id: "shipping_state" } %>
                    <% else %>
                      <%= form.text_field "shipping_address[state]", 
                          value: @shipping_address.state,
                          placeholder: "State/Province/Region",
                          class: "form-control #{'is-invalid' if @shipping_address.errors[:state].any?}",
                          id: "shipping_state" %>
                    <% end %>
                  </div>
                  <% if @shipping_address.errors[:state].any? %>
                    <div class="invalid-feedback d-block"><%= @shipping_address.errors[:state].first %></div>
                  <% end %>
                </div>
                <div class="col-md-4 mb-3">
                  <%= form.label "shipping_address[postal_code]", "ZIP/Postal Code", class: "form-label", id: "shipping-postal-label" %>
                  <%= form.text_field "shipping_address[postal_code]", 
                      value: @shipping_address.postal_code, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:postal_code].any?}" %>
                  <% if @shipping_address.errors[:postal_code].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:postal_code].first %></div>
                  <% end %>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[country]", "Country", class: "form-label" %>
                  <%= form.select "shipping_address[country]", 
                      grouped_options_for_select(countries_for_select, @shipping_address.country || "United States"), 
                      {}, 
                      { class: "form-control", id: "shipping_country" } %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= form.label "shipping_address[phone]", "Phone Number", class: "form-label" %>
                  <%= form.telephone_field "shipping_address[phone]", 
                      value: @shipping_address.phone, 
                      class: "form-control #{'is-invalid' if @shipping_address.errors[:phone].any?}",
                      placeholder: "+1 (555) 123-4567" %>
                  <% if @shipping_address.errors[:phone].any? %>
                    <div class="invalid-feedback"><%= @shipping_address.errors[:phone].first %></div>
                  <% end %>
                  <small class="form-text text-muted">Include country code for international numbers</small>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <%= link_to "Back to Cart", cart_path, class: "btn btn-outline-secondary" %>
              <%= form.submit "Continue to Payment", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <% @cart.cart_items.each do |cart_item| %>
            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
              <div class="flex-grow-1">
                <h6 class="mb-0"><%= cart_item.item_name %></h6>
                <small class="text-muted">Qty: <%= cart_item.quantity %></small>
              </div>
              <div class="text-end">
                <span class="fw-bold">$<%= cart_item.total_price %></span>
              </div>
            </div>
          <% end %>
          
          <div class="border-top pt-2 mt-3">
            <div class="d-flex justify-content-between">
              <span class="fw-bold">Subtotal:</span>
              <span class="fw-bold">$<%= @cart.total_price %></span>
            </div>
            <small class="text-muted">Shipping and tax calculated at next step</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const checkbox = document.getElementById('use_billing_for_shipping');
  const shippingSection = document.getElementById('shipping-address-section');
  
  // State/Province data
  const usStates = <%= us_states_for_select.to_json.html_safe %>;
  const canadianProvinces = <%= canadian_provinces_for_select.to_json.html_safe %>;
  
  // Function to update state/province field based on country
  function updateStateField(countrySelectId, stateContainerId, stateLabelId, stateSelectContainerId, addressPrefix) {
    const countrySelect = document.getElementById(countrySelectId);
    const stateContainer = document.getElementById(stateContainerId);
    const stateLabel = document.getElementById(stateLabelId);
    const stateSelectContainer = document.getElementById(stateSelectContainerId);
    
    if (!countrySelect || !stateContainer) return;
    
    countrySelect.addEventListener('change', function() {
      const country = this.value;
      let newField = '';
      let labelText = 'State/Province/Region';
      
      if (country === 'United States') {
        labelText = 'State';
        newField = '<select name="' + addressPrefix + '[state]" id="' + addressPrefix.replace('_address', '_state') + '" class="form-control">';
        newField += '<option value="">Select State</option>';
        usStates.forEach(function(state) {
          newField += '<option value="' + state[1] + '">' + state[0] + '</option>';
        });
        newField += '</select>';
      } else if (country === 'Canada') {
        labelText = 'Province';
        newField = '<select name="' + addressPrefix + '[state]" id="' + addressPrefix.replace('_address', '_state') + '" class="form-control">';
        newField += '<option value="">Select Province</option>';
        canadianProvinces.forEach(function(province) {
          newField += '<option value="' + province[1] + '">' + province[0] + '</option>';
        });
        newField += '</select>';
      } else {
        labelText = 'State/Province/Region';
        newField = '<input type="text" name="' + addressPrefix + '[state]" id="' + addressPrefix.replace('_address', '_state') + '" class="form-control" placeholder="State/Province/Region">';
      }
      
      stateLabel.textContent = labelText;
      stateSelectContainer.innerHTML = newField;
      
      // Update postal code label
      const postalLabel = document.getElementById(addressPrefix.replace('_address', '-postal-label'));
      if (postalLabel) {
        if (country === 'United States') {
          postalLabel.textContent = 'ZIP Code';
        } else if (country === 'Canada') {
          postalLabel.textContent = 'Postal Code';
        } else {
          postalLabel.textContent = 'ZIP/Postal Code';
        }
      }
    });
  }
  
  // Initialize for billing and shipping addresses
  updateStateField('billing_country', 'billing-state-container', 'billing-state-label', 'billing-state-select-container', 'billing_address');
  updateStateField('shipping_country', 'shipping-state-container', 'shipping-state-label', 'shipping-state-select-container', 'shipping_address');
  
  checkbox.addEventListener('change', function() {
    if (this.checked) {
      shippingSection.classList.add('collapse');
    } else {
      shippingSection.classList.remove('collapse');
    }
  });
});
</script>