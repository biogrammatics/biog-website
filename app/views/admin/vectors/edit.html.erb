<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Edit Vector: <%= @vector.name %></h1>
  <div>
    <%= link_to "View Vector", admin_vector_path(@vector), class: "btn btn-outline-info" %>
    <%= link_to "← Back to Vectors", admin_vectors_path, class: "btn btn-outline-secondary ms-2" %>
  </div>
</div>

<% if @vector.has_been_purchased? %>
  <div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i>
    <strong>Important:</strong> This vector has been purchased by <%= @vector.purchase_count %> customer(s). 
    <ul class="mb-0 mt-2">
      <li>You cannot delete this vector to preserve customer purchase history</li>
      <li>When making significant changes, consider incrementing the version number</li>
      <li>To discontinue, change the Product Status instead of deleting</li>
      <li>Customers retain access to the version they purchased</li>
    </ul>
  </div>
<% end %>

<%= form_with model: [:admin, @vector], local: true, html: { multipart: true, class: "row g-3" } do |form| %>
  <% if @vector.errors.any? %>
    <div class="col-12">
      <div class="alert alert-danger">
        <h5><%= pluralize(@vector.errors.count, "error") %> prohibited this vector from being saved:</h5>
        <ul class="mb-0">
          <% @vector.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <div class="col-md-6">
    <%= form.label :name, class: "form-label" %>
    <%= form.text_field :name, class: "form-control" %>
  </div>

  <div class="col-md-6">
    <%= form.label :category, class: "form-label" %>
    <%= form.text_field :category, class: "form-control" %>
  </div>

  <div class="col-12">
    <%= form.label :description, class: "form-label" %>
    <%= form.text_area :description, rows: 3, class: "form-control" %>
  </div>

  <div class="col-md-4">
    <%= form.label :promoter_id, "Promoter", class: "form-label" %>
    <%= form.collection_select :promoter_id, @promoters, :id, :name, { prompt: "Select promoter..." }, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= form.label :selection_marker_id, "Selection Marker", class: "form-label" %>
    <%= form.collection_select :selection_marker_id, @selection_markers, :id, :name, { prompt: "Select marker..." }, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= form.label :vector_type_id, "Vector Type", class: "form-label" %>
    <%= form.collection_select :vector_type_id, @vector_types, :id, :name, { prompt: "Select type..." }, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= form.label :host_organism_id, "Host Organism", class: "form-label" %>
    <%= form.collection_select :host_organism_id, @host_organisms, :id, :common_name, { prompt: "Select host..." }, { class: "form-select" } %>
  </div>

  <div class="col-md-4">
    <%= form.label :vector_size, "Vector Size (bp)", class: "form-label" %>
    <%= form.number_field :vector_size, class: "form-control" %>
  </div>

  <div class="col-md-4">
    <%= form.label :file_version, "Version", class: "form-label" %>
    <%= form.text_field :file_version, class: "form-control", placeholder: "e.g., 1.0, 2.0, 2.1" %>
    <div class="form-text">
      <% if @vector.has_been_purchased? %>
        <i class="bi bi-info-circle text-warning"></i> Consider incrementing when making significant changes
      <% else %>
        Version number for tracking updates
      <% end %>
    </div>
  </div>

  <div class="col-12">
    <%= form.label :features, class: "form-label" %>
    <%= form.text_area :features, rows: 3, class: "form-control" %>
  </div>

  <div class="col-12">
    <hr>
    <h5>Vector Map Image</h5>
  </div>

  <div class="col-md-6">
    <%= form.label :map_image, "Vector Map Image", class: "form-label" %>
    <%= form.file_field :map_image, class: "form-control", accept: "image/jpeg,image/png,image/webp,image/avif" %>
    <div class="form-text">Upload a high-resolution vector map (JPG, PNG, WebP, or AVIF)</div>
    
    <% if @vector.map_image.attached? %>
      <div class="mt-3">
        <h6>Current Map:</h6>
        <div class="card" style="max-width: 300px;">
          <% begin %>
            <%= image_tag @vector.map_image, class: "card-img-top", style: "max-height: 200px; object-fit: contain;" %>
          <% rescue => e %>
            <div class="card-img-top text-center py-3 bg-light">
              <i class="bi bi-exclamation-triangle text-warning"></i>
              <p class="small mb-0">Image file not found</p>
            </div>
          <% end %>
          <div class="card-body">
            <small class="text-muted">
              <%= @vector.map_image.filename %>
              (<%= number_to_human_size(@vector.map_image.byte_size) %>)
            </small>
            <%= link_to "Remove", remove_map_admin_vector_path(@vector), 
                        method: :delete,
                        data: { turbo_method: :delete, turbo_confirm: "Remove vector map?" },
                        class: "btn btn-sm btn-outline-danger mt-2" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="col-12">
    <hr>
    <h5>File Attachments</h5>
  </div>

  <div class="col-md-6">
    <%= form.label :files, "Add SnapGene/GenBank Files", class: "form-label" %>
    <%= form.file_field :files, multiple: true, class: "form-control", accept: ".dna,.gb,.gbk" %>
    <div class="form-text">
      <strong>Add new files:</strong> Accepted formats: .dna (SnapGene), .gb, .gbk (GenBank)<br>
      <small class="text-muted"><i class="bi bi-info-circle"></i> New files will be added to existing ones. Use "Remove" buttons below to delete individual files.</small>
    </div>
    
    <% if @vector.files.attached? %>
      <div class="mt-3">
        <h6>Current Files:</h6>
        <ul class="list-group">
          <% @vector.files.each do |file| %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <i class="bi bi-file-earmark-binary"></i>
                <%= file.filename %>
                <small class="text-muted">(<%= number_to_human_size(file.byte_size) %>)</small>
              </div>
              <%= link_to "Remove", remove_file_admin_vector_path(@vector, file_id: file.id), 
                          method: :delete, 
                          data: { turbo_method: :delete, turbo_confirm: "Remove this file?" },
                          class: "btn btn-sm btn-outline-danger" %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>

  <div class="col-md-6">
    <%= form.label :product_status_id, "Product Status", class: "form-label" %>
    <%= form.collection_select :product_status_id, @product_statuses, :id, :name, { prompt: "Select status..." }, { class: "form-select" } %>
  </div>

  <div class="col-md-6">
    <label class="form-label">Options</label>
    <div class="form-check">
      <%= form.check_box :has_lox_sites, class: "form-check-input" %>
      <%= form.label :has_lox_sites, "Has Lox Sites", class: "form-check-label" %>
    </div>
    <div class="form-check">
      <%= form.check_box :has_files, class: "form-check-input" %>
      <%= form.label :has_files, "Has Files Available", class: "form-check-label" %>
    </div>
  </div>

  <div class="col-md-6">
    <div class="form-check">
      <%= form.check_box :available_for_sale, class: "form-check-input" %>
      <%= form.label :available_for_sale, "Available for Sale", class: "form-check-label" %>
    </div>
    <div class="form-check">
      <%= form.check_box :available_for_subscription, class: "form-check-input" %>
      <%= form.label :available_for_subscription, "Available for Subscription", class: "form-check-label" %>
    </div>
  </div>

  <div class="col-md-6">
    <%= form.label :sale_price, "Sale Price ($)", class: "form-label" %>
    <%= form.number_field :sale_price, step: 0.01, class: "form-control" %>
  </div>

  <div class="col-md-6">
    <%= form.label :subscription_price, "Annual Subscription Price ($)", class: "form-label" %>
    <%= form.number_field :subscription_price, step: 0.01, class: "form-control" %>
  </div>

  <div class="col-12">
    <hr>
    <div class="d-flex gap-2">
      <%= form.submit "Update Vector", class: "btn btn-success" %>
      <%= link_to "Cancel", admin_vector_path(@vector), class: "btn btn-outline-secondary" %>
    </div>
  </div>
<% end %>
