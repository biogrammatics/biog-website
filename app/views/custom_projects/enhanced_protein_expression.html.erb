<div class="container-custom py-8">
  <!-- Breadcrumb -->
  <nav class="mb-6">
    <ol class="flex items-center gap-2 text-sm text-gray-600">
      <li><%= link_to "Home", root_path, class: "hover:text-gray-900" %></li>
      <li><i class="bi bi-chevron-right text-xs"></i></li>
      <li><%= link_to "Services", services_custom_projects_path, class: "hover:text-gray-900" %></li>
      <li><i class="bi bi-chevron-right text-xs"></i></li>
      <li class="text-gray-900 font-medium">Enhanced Protein Expression</li>
    </ol>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <h1 class="flex items-center text-3xl font-bold mb-6">
        <i class="bi bi-dna mr-3 text-blue-600"></i>
        Enhanced Strain Construction Service
      </h1>

      <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
        <h5 class="text-lg font-semibold mb-3">Complete Strain Construction Workflow</h5>
        <p class="mb-3">We'll construct custom Pichia strains with your genes integrated into the genome:</p>
        <ul class="list-disc list-inside space-y-1">
          <li>Proprietary Pichia codon optimization algorithm</li>
          <li>DNA synthesis and vector cloning (methanol-inducible or constitutive)</li>
          <li>Transformation into your chosen strain (default: BG11)</li>
          <li>Robotic colony picking and single colony isolation</li>
          <li>Drug marker integration verification</li>
          <li>Delivery of plate with single colony isolates</li>
        </ul>
      </div>

      <% unless authenticated? %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-6">
          <h5 class="text-lg font-semibold mb-3">Account Required</h5>
          <p class="mb-4">To submit a protein expression request, you'll need to create an account or sign in. This helps us manage your project and keep you updated on progress.</p>
          <div class="border-t border-yellow-200 my-4"></div>
          <div class="flex gap-3">
            <%= link_to "Sign In", new_session_path, class: "inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors" %>
            <%= link_to "Create Account", new_session_path, class: "inline-flex items-center px-6 py-3 border-2 border-blue-600 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-colors" %>
          </div>
        </div>
        <div class="border-t border-gray-200 my-6"></div>
        <h5 class="text-lg font-semibold mb-2">Preview Request Form</h5>
        <p class="text-gray-600 mb-6">You can review the request form below, then sign in to submit your request.</p>
      <% end %>

      <%= form_with model: @form, url: authenticated? ? enhanced_protein_expression_custom_projects_path : "#", local: true, multipart: true do |form| %>
        <% if @form.errors.any? %>
          <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-6">
            <h4 class="text-lg font-semibold mb-3"><%= pluralize(@form.errors.count, "error") %> prohibited this request from being saved:</h4>
            <ul class="list-disc list-inside space-y-1">
              <% @form.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- Project Details -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h5 class="text-lg font-semibold">Project Details</h5>
          </div>
          <div class="p-6">
            <div class="mb-4">
              <%= form.label :project_name, "Project Name", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :project_name, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors", placeholder: "e.g., Multi-protein expression project" %>
              <small class="text-sm text-gray-600">Give your project a descriptive name for tracking</small>
            </div>

            <div class="mb-4">
              <%= form.label :notes, "Project Notes (Optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :notes, rows: 3, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors",
                  placeholder: "Any special requirements, timeline constraints, or questions?" %>
            </div>
          </div>
        </div>

        <!-- Input Method Selection -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h5 class="text-lg font-semibold">Protein Input Method</h5>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="flex items-start">
                  <%= form.radio_button :input_method, "manual", class: "mt-1 mr-2", id: "input_manual", checked: true %>
                  <%= form.label :input_method, "Manual Entry", class: "font-medium", for: "input_manual" %>
                </div>
                <small class="block text-gray-600 ml-6">Enter protein sequences manually with modification tools</small>
              </div>
              <div>
                <div class="flex items-start">
                  <%= form.radio_button :input_method, "fasta", class: "mt-1 mr-2", id: "input_fasta" %>
                  <%= form.label :input_method, "FASTA File Upload", class: "font-medium", for: "input_fasta" %>
                </div>
                <small class="block text-gray-600 ml-6">Upload a FASTA file with multiple sequences</small>
              </div>
            </div>
          </div>
        </div>

        <!-- FASTA Upload Section -->
        <div id="fasta-upload-section" class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6" style="display: none;">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h5 class="text-lg font-semibold flex items-center">
              <i class="bi bi-upload mr-2"></i>
              FASTA File Upload
            </h5>
          </div>
          <div class="p-6">
            <div class="mb-4">
              <%= form.label :fasta_file, "Select FASTA File", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.file_field :fasta_file, class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors", accept: ".fasta,.fas,.txt,.fa" %>
              <small class="text-sm text-gray-600">
                Supported formats: .fasta, .fas, .fa, .txt
              </small>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-4">
              <h6 class="font-semibold mb-2">FASTA Format Requirements:</h6>
              <ul class="list-disc list-inside space-y-1">
                <li>Each protein must start with a header line beginning with ">"</li>
                <li>Header format: >ProteinName [description] or >ProteinName description</li>
                <li>Amino acid sequences using single-letter codes (ARNDCEQGHILKMFPSTWYV)</li>
                <li>Sequences will be automatically validated and formatted</li>
              </ul>
            </div>

            <div class="bg-gray-50 rounded-xl border border-gray-200 p-6">
              <h6 class="font-semibold mb-2">Example FASTA format:</h6>
              <pre class="text-sm"><code>>Insulin [Human insulin hormone]
MALWMRLLPLLALLALWGPDPAAAFVNQHLCGSHLVEALYLVCGERGFFYTPKTRREAEDLQVGQVELGGGPGAGSLQPLALEGSLQKRGIVEQCCTSICSLYQLENYCN*

>Lysozyme [Chicken egg white lysozyme]
MKALIVLGLVLLSVTVQGKVFERCELARTLKRLGMDGYRGISLANWMCLAKWESGYNTRATNYNAGDRSTDYGIFQINSRYWCNDGKTPGAVNACHLSCSALLQDNIADAVACAKRVVRDPQGIRAWVAWRNRCQNRDVRQYVQGCGV*</code></pre>
            </div>
          </div>
        </div>

        <!-- Manual Protein Entry Section -->
        <div id="manual-entry-section" class="mb-6">
          <div class="flex justify-content-between items-center mb-4">
            <h5 class="text-lg font-semibold">Protein Sequences</h5>
            <button type="button" id="add-protein-btn" class="inline-flex items-center px-4 py-2 border-2 border-blue-600 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-colors text-sm">
              <i class="bi bi-plus-lg mr-2"></i>Add Another Protein
            </button>
          </div>

          <div id="proteins-container">
            <!-- Protein forms will be inserted here -->
          </div>
        </div>

        <!-- Optional Services -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h5 class="text-lg font-semibold">Optional Add-On Services</h5>
          </div>
          <div class="p-6">
            <div class="mb-4">
              <div class="flex items-start">
                <input type="checkbox" class="mt-1 mr-3" id="copy_number_determination"
                       name="enhanced_protein_expression_form[copy_number_determination]" value="1">
                <label class="flex-1" for="copy_number_determination">
                  <div class="flex items-center gap-2 mb-1">
                    <strong>Copy Number Determination</strong>
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-100 text-blue-700 text-xs font-medium">+$350</span>
                  </div>
                  <small class="text-gray-600">qPCR assay development and analysis to determine gene copy number in your strains</small>
                </label>
              </div>
            </div>

            <div class="mb-4">
              <div class="flex items-start">
                <input type="checkbox" class="mt-1 mr-3" id="glycerol_stocks"
                       name="enhanced_protein_expression_form[glycerol_stocks]" value="1">
                <label class="flex-1" for="glycerol_stocks">
                  <div class="flex items-center gap-2 mb-1">
                    <strong>Glycerol Stock Generation & Shipping</strong>
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-100 text-blue-700 text-xs font-medium">+$200</span>
                  </div>
                  <small class="text-gray-600">Receive glycerol stocks instead of (or in addition to) plates. Includes dry ice shipping.</small>
                </label>
              </div>
            </div>

            <div>
              <div class="flex items-start">
                <input type="checkbox" class="mt-1 mr-3" id="strain_selection"
                       name="enhanced_protein_expression_form[custom_strain_selection]" value="1">
                <label class="flex-1" for="strain_selection">
                  <div class="flex items-center gap-2 mb-1">
                    <strong>Custom Strain Selection</strong>
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-100 text-blue-700 text-xs font-medium">Contact for pricing</span>
                  </div>
                  <small class="text-gray-600">Use a specific Pichia strain other than BG11 (e.g., protease-deficient, glycosylation-modified)</small>
                </label>
              </div>
            </div>

            <div class="mt-4" id="custom-strain-input" style="display: none;">
              <label class="block text-sm font-medium text-gray-700 mb-2">Specify desired strain:</label>
              <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors" name="enhanced_protein_expression_form[custom_strain_name]"
                     placeholder="e.g., SMD1168, GS115, KM71H">
            </div>
          </div>
        </div>

        <!-- Vector Selection -->
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden mb-6">
          <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
            <h5 class="text-lg font-semibold">Expression Vector Selection</h5>
          </div>
          <div class="p-6">
            <p class="text-gray-600 mb-4">Choose between methanol-inducible (AOX1 promoter) or constitutive expression (GAP promoter).</p>

            <% @expression_vectors.each do |vector| %>
              <div class="mb-4">
                <div class="flex items-start">
                  <%= form.radio_button :selected_vector_id, vector.id, class: "mt-1 mr-3", id: "vector_#{vector.id}" %>
                  <%= form.label :selected_vector_id, class: "flex-1 cursor-pointer", for: "vector_#{vector.id}" do %>
                    <div class="bg-white rounded-xl border border-gray-200 p-4 hover:border-bio-green transition-colors">
                      <div class="flex justify-between items-start">
                        <div class="flex-1">
                          <h6 class="font-semibold mb-1"><%= vector.display_name %></h6>
                          <p class="text-gray-600 mb-3"><%= vector.description %></p>

                          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                              <small class="text-sm text-gray-700">
                                <strong>Backbone:</strong> <%= vector.backbone %><br>
                                <strong>Cloning Sites:</strong> <%= vector.cloning_sites %>
                              </small>
                            </div>
                            <div>
                              <small class="text-sm text-gray-700">
                                <% if vector.feature_list.any? %>
                                  <strong>Features:</strong> <%= vector.feature_list.join(', ') %>
                                <% end %>
                              </small>
                            </div>
                          </div>
                        </div>
                        <div class="text-right ml-4">
                          <h6 class="text-blue-600 font-semibold"><%= vector.formatted_price %></h6>
                          <small class="text-gray-600">per vector</small>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Next Steps -->
        <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-6">
          <h5 class="text-lg font-semibold flex items-center mb-3">
            <i class="bi bi-lightbulb mr-2"></i>What You'll Receive
          </h5>
          <p class="mb-4">Your complete strain construction package includes:</p>
          <ul class="list-disc list-inside space-y-2 mb-4">
            <li><strong>Plate with Single Colony Isolates:</strong> Verified transformants ready for culture</li>
            <li><strong>Drug Marker Verification:</strong> Confirmed genomic integration</li>
            <li><strong>Strain Documentation:</strong> Complete construct information and sequences</li>
            <li><strong>Optional:</strong> Copy number data and/or glycerol stocks if selected</li>
          </ul>

          <h6 class="font-semibold mb-2">Timeline:</h6>
          <ol class="list-decimal list-inside space-y-1">
            <li>Sequence optimization & review (24-48 hours)</li>
            <li>DNA synthesis & cloning (5-7 days)</li>
            <li>Transformation & colony isolation (3-5 days)</li>
            <li>Verification & quality control (2-3 days)</li>
            <li>Shipping (1-3 days depending on location)</li>
          </ol>
        </div>

        <!-- Submit Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 mb-8">
          <% if authenticated? %>
            <%= form.submit "Submit Enhanced Protein Expression Request", class: "inline-flex items-center justify-center px-6 py-3 bg-bio-green text-white font-medium rounded-lg hover:bg-bio-green-dark transition-colors" %>
            <%= link_to "Cancel", custom_projects_path, class: "inline-flex items-center justify-center px-6 py-3 border-2 border-gray-400 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors" %>
          <% else %>
            <%= link_to "Sign In to Submit Request", new_session_path, class: "inline-flex items-center justify-center px-6 py-3 bg-bio-green text-white font-medium rounded-lg hover:bg-bio-green-dark transition-colors" %>
            <%= link_to "Back to Services", services_custom_projects_path, class: "inline-flex items-center justify-center px-6 py-3 border-2 border-gray-400 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-xl border border-gray-200 overflow-hidden sticky top-5">
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
          <h6 class="font-semibold">Enhanced Service Features</h6>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <h6 class="text-blue-600 font-semibold mb-1">✓ Multi-Protein Support</h6>
            <small class="text-gray-600">Submit multiple proteins in a single request for batch processing</small>
          </div>

          <div class="mb-4">
            <h6 class="text-blue-600 font-semibold mb-1">✓ FASTA File Upload</h6>
            <small class="text-gray-600">Upload sequences directly from bioinformatics tools</small>
          </div>

          <div class="mb-4">
            <h6 class="text-blue-600 font-semibold mb-1">✓ Secretion Signals</h6>
            <small class="text-gray-600">Choose from optimized secretion signals for protein export</small>
          </div>

          <div class="mb-4">
            <h6 class="text-blue-600 font-semibold mb-1">✓ Purification Tags</h6>
            <small class="text-gray-600">Add His-tags, FLAG, GST, and other purification tags</small>
          </div>

          <div class="border-t border-gray-200 my-4"></div>

          <div class="text-center mb-4">
            <h6 class="text-bio-green font-semibold">Starting at $750</h6>
            <small class="text-gray-600">Per protein + vector costs</small>
          </div>

          <div class="border-t border-gray-200 my-4"></div>

          <div>
            <h6 class="font-semibold mb-2">Need Help?</h6>
            <small class="text-gray-600">
              Questions about sequence requirements or modifications?
              <%= link_to "Contact our team", "#", class: "text-blue-600 hover:text-blue-700" %> for guidance.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Protein Form Template -->
<template id="protein-form-template">
  <div class="protein-form bg-white rounded-xl border border-gray-200 overflow-hidden mb-4">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
      <h6 class="font-semibold">Protein <span class="protein-number">1</span></h6>
      <button type="button" class="inline-flex items-center px-3 py-1 border-2 border-red-600 text-red-600 font-medium rounded-lg hover:bg-red-50 transition-colors text-sm remove-protein-btn">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="p-6">
      <!-- Protein details will be inserted here -->
    </div>
  </div>
</template>

<!-- Data for JavaScript -->
<script>
  window.proteinFormData = {
    secretionSignals: <%= raw SecretionSignal.active.map { |s| { name: s.display_name, value: s.sequence } }.to_json %>,
    nTerminalTags: <%= raw ProteinTag.active.n_terminal.map { |t| { name: t.display_name, value: t.sequence } }.to_json %>,
    cTerminalTags: <%= raw ProteinTag.active.c_terminal.map { |t| { name: t.display_name, value: t.sequence } }.to_json %>
  };
</script>

<!-- Enhanced Protein Expression JavaScript - Inline for production compatibility -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('Enhanced Protein Expression JS starting...');

  // Get DOM elements
  const inputMethodRadios = document.querySelectorAll('input[name="enhanced_protein_expression_form[input_method]"]');
  const fastaSection = document.getElementById('fasta-upload-section');
  const manualSection = document.getElementById('manual-entry-section');
  const addProteinBtn = document.getElementById('add-protein-btn');
  const proteinsContainer = document.getElementById('proteins-container');
  const customStrainCheckbox = document.getElementById('strain_selection');
  const customStrainInput = document.getElementById('custom-strain-input');

  let proteinCount = 0;

  // Get data from window object (set by the view above)
  const secretionSignals = window.proteinFormData?.secretionSignals || [];
  const nTerminalTags = window.proteinFormData?.nTerminalTags || [];
  const cTerminalTags = window.proteinFormData?.cTerminalTags || [];

  // Debug logging
  console.log('Data available:', {
    secretionSignals: secretionSignals.length,
    nTerminalTags: nTerminalTags.length,
    cTerminalTags: cTerminalTags.length
  });

  if (secretionSignals.length === 0) {
    console.warn('No secretion signals found - database may not be seeded');
  }

  // Handle custom strain selection
  if (customStrainCheckbox) {
    customStrainCheckbox.addEventListener('change', function() {
      customStrainInput.style.display = this.checked ? 'block' : 'none';
    });
  }

  // Handle input method switching
  inputMethodRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.value === 'fasta') {
        fastaSection.style.display = 'block';
        manualSection.style.display = 'none';
      } else {
        fastaSection.style.display = 'none';
        manualSection.style.display = 'block';
        if (proteinCount === 0) {
          addProteinForm();
        }
      }
    });
  });

  // Initialize with manual input (default)
  if (manualSection && fastaSection) {
    manualSection.style.display = 'block';
    fastaSection.style.display = 'none';
    addProteinForm();
  }

  // Add protein form
  if (addProteinBtn) {
    addProteinBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Add protein button clicked');
      addProteinForm();
    });
    console.log('Add protein button listener attached');
  } else {
    console.error('Add protein button not found!');
  }

  function addProteinForm() {
    console.log('Adding protein form #' + (proteinCount + 1));
    proteinCount++;
    const proteinForm = createProteinForm(proteinCount);
    if (proteinsContainer) {
      proteinsContainer.appendChild(proteinForm);
      updateRemoveButtons();
      console.log('Protein form added successfully');
    } else {
      console.error('Proteins container not found!');
    }
  }

  function createProteinForm(number) {
    const div = document.createElement('div');
    div.className = 'protein-form bg-white rounded-xl border border-gray-200 overflow-hidden mb-4';

    // Build secretion signal options
    let secretionSignalOptions = '<option value="">None</option>';
    secretionSignals.forEach(signal => {
      secretionSignalOptions += '<option value="' + escapeHtml(signal.value) + '">' + escapeHtml(signal.name) + '</option>';
    });

    // Build N-terminal tag options
    let nTerminalOptions = '<option value="">None</option>';
    nTerminalTags.forEach(tag => {
      nTerminalOptions += '<option value="' + escapeHtml(tag.value) + '">' + escapeHtml(tag.name) + '</option>';
    });

    // Build C-terminal tag options
    let cTerminalOptions = '<option value="">None</option>';
    cTerminalTags.forEach(tag => {
      cTerminalOptions += '<option value="' + escapeHtml(tag.value) + '">' + escapeHtml(tag.name) + '</option>';
    });

    div.innerHTML =
      '<div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">' +
        '<h6 class="font-semibold">Protein ' + number + '</h6>' +
        '<button type="button" class="inline-flex items-center px-3 py-1 border-2 border-red-600 text-red-600 font-medium rounded-lg hover:bg-red-50 transition-colors text-sm remove-protein-btn">' +
          '<i class="bi bi-x-lg"></i>' +
        '</button>' +
      '</div>' +
      '<div class="p-6">' +
        '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
          '<div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-2">Protein Name</label>' +
              '<input type="text" name="enhanced_protein_expression_form[proteins_attributes][' + (number-1) + '][name]"' +
                     ' class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors" placeholder="e.g., Human Insulin">' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>' +
              '<input type="text" name="enhanced_protein_expression_form[proteins_attributes][' + (number-1) + '][description]"' +
                     ' class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors" placeholder="Brief description">' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="mb-4">' +
          '<label class="block text-sm font-medium text-gray-700 mb-2">Amino Acid Sequence</label>' +
          '<textarea name="enhanced_protein_expression_form[proteins_attributes][' + (number-1) + '][amino_acid_sequence]"' +
                    ' rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors font-mono sequence-input"' +
                    ' placeholder="MATLYGDSGLWQNILDQLSSLLNQAEGLQAAGGSALQY*"></textarea>' +
          '<small class="text-sm text-gray-600">Single-letter amino acid codes (A-Z, *)</small>' +
        '</div>' +
        '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">' +
          '<div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-2">Secretion Signal</label>' +
              '<select name="enhanced_protein_expression_form[proteins_attributes][' + (number-1) + '][secretion_signal]"' +
                      ' class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors">' +
                secretionSignalOptions +
              '</select>' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-2">N-Terminal Tag</label>' +
              '<select name="enhanced_protein_expression_form[proteins_attributes][' + (number-1) + '][n_terminal_tag]"' +
                      ' class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors">' +
                nTerminalOptions +
              '</select>' +
            '</div>' +
          '</div>' +
          '<div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-2">C-Terminal Tag</label>' +
              '<select name="enhanced_protein_expression_form[proteins_attributes][' + (number-1) + '][c_terminal_tag]"' +
                      ' class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bio-green focus:border-bio-green transition-colors">' +
                cTerminalOptions +
              '</select>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

    // Add remove functionality
    const removeBtn = div.querySelector('.remove-protein-btn');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        div.remove();
        proteinCount--;
        updateProteinNumbers();
        updateRemoveButtons();
      });
    }

    // Add sequence formatting
    const sequenceInput = div.querySelector('.sequence-input');
    if (sequenceInput) {
      sequenceInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^ARNDCEQGHILKMFPSTWYV*\s]/g, '');
      });
    }

    return div;
  }

  function updateProteinNumbers() {
    if (!proteinsContainer) return;
    const forms = proteinsContainer.querySelectorAll('.protein-form');
    forms.forEach((form, index) => {
      const numberSpan = form.querySelector('.protein-number');
      if (numberSpan) {
        numberSpan.textContent = index + 1;
      }

      // Update input names
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        if (input.name) {
          input.name = input.name.replace(/\[\d+\]/, '[' + index + ']');
        }
      });
    });
  }

  function updateRemoveButtons() {
    if (!proteinsContainer) return;
    const forms = proteinsContainer.querySelectorAll('.protein-form');
    const removeButtons = proteinsContainer.querySelectorAll('.remove-protein-btn');

    removeButtons.forEach(btn => {
      btn.style.display = forms.length > 1 ? 'block' : 'none';
    });
  }

  function escapeHtml(text) {
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
  }

  console.log('Enhanced Protein Expression JS loaded successfully');
});
</script>