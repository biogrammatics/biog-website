<div class="container mt-4">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Home", root_path %></li>
      <li class="breadcrumb-item"><%= link_to "Services", services_custom_projects_path %></li>
      <li class="breadcrumb-item active" aria-current="page">Protein Expression</li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-8">
      <h1 class="mb-4">
        <i class="fas fa-dna me-2 text-primary"></i>
        Protein Expression Strain Request
      </h1>
      
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">How It Works</h5>
        </div>
        <div class="card-body">
          <ol class="mb-0">
            <li><strong>Provide Your Protein Sequence:</strong> Submit the amino acid sequence of your protein (starting with M, ending with *)</li>
            <li><strong>Choose Your Vector:</strong> Select from our catalog of expression vectors</li>
            <li><strong>We Optimize:</strong> Our proprietary codon optimization generates the optimal DNA sequence</li>
            <li><strong>You Approve:</strong> Review and approve the generated DNA sequence</li>
            <li><strong>We Deliver:</strong> Synthesize, clone, and deliver your custom Pichia strain</li>
          </ol>
        </div>
      </div>

      <% unless authenticated? %>
        <div class="alert alert-info">
          <h5 class="alert-heading">Account Required</h5>
          <p>To submit a protein expression request, you'll need to create an account or sign in. This helps us manage your project and keep you updated on progress.</p>
          <hr>
          <div class="d-flex gap-2">
            <%= link_to "Sign In", new_session_path, class: "btn btn-primary" %>
            <%= link_to "Create Account", new_session_path, class: "btn btn-outline-primary" %>
          </div>
        </div>
        <hr>
        <h5>Preview Request Form</h5>
        <p class="text-muted">You can review the request form below, then sign in to submit your request.</p>
      <% end %>

      <%= form_with model: @form, url: authenticated? ? protein_expression_custom_projects_path : "#", local: true do |form| %>
        <% if @form.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@form.errors.count, "error") %> prohibited this request from being saved:</h4>
            <ul class="mb-0">
              <% @form.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- Project Details -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Project Details</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :project_name, "Project Name", class: "form-label" %>
              <%= form.text_field :project_name, class: "form-control", placeholder: "e.g., Human insulin expression in Pichia" %>
              <small class="form-text text-muted">Give your project a descriptive name for tracking</small>
            </div>
            
            <div class="mb-3">
              <%= form.label :protein_name, "Protein Name", class: "form-label" %>
              <%= form.text_field :protein_name, class: "form-control", placeholder: "e.g., Human Insulin" %>
              <small class="form-text text-muted">The name of the protein you want to express</small>
            </div>

            <div class="mb-3">
              <%= form.label :protein_description, "Protein Description (Optional)", class: "form-label" %>
              <%= form.text_area :protein_description, rows: 3, class: "form-control", 
                  placeholder: "Describe the protein function, origin, special requirements..." %>
              <small class="form-text text-muted">Any additional information about your protein</small>
            </div>
          </div>
        </div>

        <!-- Amino Acid Sequence -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Amino Acid Sequence</h5>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <strong>Sequence Requirements:</strong>
              <ul class="mb-0">
                <li>Use single-letter amino acid code (A, R, N, D, C, E, Q, G, H, I, L, K, M, F, P, S, T, W, Y, V)</li>
                <li>Must start with methionine (M)</li>
                <li>Must end with stop codon (*)</li>
                <li>Whitespace and line breaks will be ignored</li>
              </ul>
            </div>
            
            <div class="mb-3">
              <%= form.label :amino_acid_sequence, "Amino Acid Sequence", class: "form-label" %>
              <%= form.text_area :amino_acid_sequence, rows: 8, class: "form-control font-monospace", 
                  placeholder: "MATLYGDSGLWQNILDQLSSLLNQAEGLQAAGGSALQY*", 
                  style: "font-size: 0.9rem; line-height: 1.4;" %>
              <small class="form-text text-muted">Paste your complete amino acid sequence here</small>
            </div>

            <% if @form.amino_acid_sequence.present? %>
              <div class="card bg-light">
                <div class="card-body py-2">
                  <small>
                    <strong>Sequence Length:</strong> <%= @form.sequence_length %> amino acids |
                    <strong>Starts with M:</strong> <%= @form.starts_with_methionine? ? '✓ Yes' : '✗ No' %> |
                    <strong>Ends with *:</strong> <%= @form.ends_with_stop_codon? ? '✓ Yes' : '✗ No' %>
                    <% if @form.sequence_length > 0 %>
                      | <strong>Estimated MW:</strong> ~<%= number_with_delimiter(@form.estimated_molecular_weight) %> Da
                    <% end %>
                  </small>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Vector Selection -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Expression Vector Selection</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">Choose the expression vector that best fits your protein and experimental needs.</p>
            
            <% @expression_vectors.each do |vector| %>
              <div class="form-check mb-3">
                <%= form.radio_button :selected_vector_id, vector.id, class: "form-check-input", id: "vector_#{vector.id}" %>
                <%= form.label :selected_vector_id, class: "form-check-label w-100", for: "vector_#{vector.id}" do %>
                  <div class="card">
                    <div class="card-body py-3">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                          <h6 class="mb-1"><%= vector.display_name %></h6>
                          <p class="text-muted mb-2"><%= vector.description %></p>
                          
                          <div class="row">
                            <div class="col-sm-6">
                              <small>
                                <strong>Backbone:</strong> <%= vector.backbone %><br>
                                <strong>Cloning Sites:</strong> <%= vector.cloning_sites %>
                              </small>
                            </div>
                            <div class="col-sm-6">
                              <small>
                                <% if vector.feature_list.any? %>
                                  <strong>Features:</strong> <%= vector.feature_list.join(', ') %>
                                <% end %>
                              </small>
                            </div>
                          </div>
                          
                          <% if vector.additional_notes.present? %>
                            <small class="text-info"><%= vector.additional_notes %></small>
                          <% end %>
                        </div>
                        <div class="text-end ms-3">
                          <h6 class="text-primary mb-0"><%= vector.formatted_price %></h6>
                          <small class="text-muted">per vector</small>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Additional Notes -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Additional Information</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <%= form.label :notes, "Special Requirements or Notes (Optional)", class: "form-label" %>
              <%= form.text_area :notes, rows: 4, class: "form-control", 
                  placeholder: "Any special requirements, timeline constraints, expression conditions, or questions?" %>
              <small class="form-text text-muted">Help us understand your specific needs</small>
            </div>
          </div>
        </div>

        <!-- Next Steps -->
        <div class="alert alert-success">
          <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>What happens next?</h5>
          <ol class="mb-0">
            <li><strong>Submit Request:</strong> Submit your protein sequence and vector choice</li>
            <li><strong>DNA Generation:</strong> We'll generate the codon-optimized DNA sequence (24-48 hours)</li>
            <li><strong>Sequence Approval:</strong> Review and approve the DNA sequence we provide</li>
            <li><strong>Synthesis & Cloning:</strong> We synthesize the DNA and clone into your chosen vector</li>
            <li><strong>Strain Delivery:</strong> Receive your custom Pichia pastoris expression strain</li>
          </ol>
        </div>

        <!-- Submit Buttons -->
        <div class="d-grid gap-2 d-md-block mb-5">
          <% if authenticated? %>
            <%= form.submit "Submit Protein Expression Request", class: "btn btn-success btn-lg" %>
            <%= link_to "Cancel", custom_projects_path, class: "btn btn-outline-secondary btn-lg" %>
          <% else %>
            <%= link_to "Sign In to Submit Request", new_session_path, class: "btn btn-success btn-lg" %>
            <%= link_to "Back to Projects", custom_projects_path, class: "btn btn-outline-secondary btn-lg" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card position-sticky" style="top: 20px;">
        <div class="card-header">
          <h6 class="mb-0">Protein Expression Services</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6 class="text-primary">✓ Codon Optimization</h6>
            <small class="text-muted">Proprietary Pichia pastoris codon optimization for maximum expression</small>
          </div>
          
          <div class="mb-3">
            <h6 class="text-primary">✓ Vector Cloning</h6>
            <small class="text-muted">Professional cloning into your selected expression vector</small>
          </div>
          
          <div class="mb-3">
            <h6 class="text-primary">✓ Strain Transformation</h6>
            <small class="text-muted">Pichia pastoris transformation and strain isolation</small>
          </div>
          
          <div class="mb-3">
            <h6 class="text-primary">✓ Quality Control</h6>
            <small class="text-muted">Sequence verification and expression confirmation</small>
          </div>
          
          <hr>
          
          <div class="text-center">
            <h6 class="text-success">Starting at $750</h6>
            <small class="text-muted">Final pricing depends on vector choice and complexity</small>
          </div>
          
          <hr>
          
          <div>
            <h6>Need Help?</h6>
            <small class="text-muted">
              Not sure which vector to choose? Have questions about your protein? 
              <%= link_to "Contact our team", "#", class: "text-primary" %> for personalized guidance.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sequenceTextarea = document.querySelector('textarea[name="custom_project[amino_acid_sequence]"]');
  
  if (sequenceTextarea) {
    sequenceTextarea.addEventListener('input', function() {
      // Auto-format sequence as user types
      let value = this.value.toUpperCase();
      // Remove invalid characters but keep whitespace for formatting
      value = value.replace(/[^ARNDCEQGHILKMFPSTWYV*\s]/g, '');
      this.value = value;
    });
  }
});
</script>