<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8">
      <div class="checkout-progress mb-4">
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-primary" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemax="100"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <small class="text-success">✓ Address</small>
          <small class="text-success">✓ Payment</small>
          <small class="text-primary fw-bold">3. Review & Place Order</small>
        </div>
      </div>

      <!-- Order Items Review -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Order Items</h5>
        </div>
        <div class="card-body">
          <% @cart.cart_items.each do |cart_item| %>
            <div class="row align-items-center border-bottom pb-3 mb-3">
              <div class="col-md-6">
                <h6 class="mb-1"><%= cart_item.item_name %></h6>
                <p class="text-muted mb-0 small"><%= cart_item.item_description %></p>
              </div>
              <div class="col-md-2 text-center">
                <span class="fw-bold">Qty: <%= cart_item.quantity %></span>
              </div>
              <div class="col-md-2 text-center">
                <span>$<%= cart_item.price %> each</span>
              </div>
              <div class="col-md-2 text-end">
                <span class="fw-bold">$<%= cart_item.total_price %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Address Review -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Shipping & Billing Information</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="border-bottom pb-2">Billing Address</h6>
              <address class="mb-0">
                <strong><%= @billing_address.display_name %></strong><br>
                <%= simple_format(@billing_address.full_address) %>
                <br>
                <strong>Phone:</strong> <%= @billing_address.phone %>
              </address>
            </div>
            <div class="col-md-6">
              <h6 class="border-bottom pb-2">Shipping Address</h6>
              <address class="mb-0">
                <strong><%= @shipping_address.display_name %></strong><br>
                <%= simple_format(@shipping_address.full_address) %>
                <br>
                <strong>Phone:</strong> <%= @shipping_address.phone %>
              </address>
            </div>
          </div>
          
          <div class="mt-3">
            <%= link_to "Edit Addresses", address_step_checkout_index_path, class: "btn btn-sm btn-outline-primary" %>
          </div>
        </div>
      </div>

      <!-- Order Totals -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Order Total</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="d-flex justify-content-between py-2">
                <span>Subtotal:</span>
                <span>$<%= sprintf("%.2f", @order_summary[:subtotal]) %></span>
              </div>
              <div class="d-flex justify-content-between py-2">
                <span>Shipping:</span>
                <span>
                  <% if @order_summary[:shipping_cost] == 0 %>
                    <span class="text-success">FREE</span>
                  <% else %>
                    $<%= sprintf("%.2f", @order_summary[:shipping_cost]) %>
                  <% end %>
                </span>
              </div>
              <div class="d-flex justify-content-between py-2">
                <span>Tax (<%= sprintf("%.1f%%", @order_summary[:tax_rate] * 100) %>):</span>
                <span>$<%= sprintf("%.2f", @order_summary[:tax_amount]) %></span>
              </div>
              <hr>
              <div class="d-flex justify-content-between py-2">
                <strong>Total:</strong>
                <strong class="text-primary fs-5">$<%= sprintf("%.2f", @order_summary[:total]) %></strong>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body p-3">
                  <h6 class="card-title">Shipping Details</h6>
                  <p class="card-text small mb-2">
                    <% if @order_summary[:shipping_cost] == 0 %>
                      <strong class="text-success">Free Shipping!</strong><br>
                      Orders over $150 ship free.
                    <% else %>
                      Standard shipping to <%= @shipping_address.state %>
                      <% if %w[AK HI].include?(@shipping_address.state) %>
                        <br><small class="text-muted">Additional charge for AK/HI delivery</small>
                      <% end %>
                    <% end %>
                  </p>
                  <p class="card-text small text-muted mb-0">
                    Estimated delivery: 5-7 business days
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Place Order -->
      <div class="card">
        <div class="card-body">
          <%= form_with url: review_step_checkout_index_path, method: :post, local: true do |form| %>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Ready to place your order?</strong>
              <p class="mb-0">By clicking "Place Order" below, you agree to our terms and conditions. Your order will be processed and you'll receive a confirmation email.</p>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
              <%= link_to "Back to Payment", payment_step_checkout_index_path, class: "btn btn-outline-secondary" %>
              <%= form.submit "Place Order", class: "btn btn-success btn-lg",
                  data: { turbo_confirm: "Are you sure you want to place this order for $#{sprintf('%.2f', @order_summary[:total])}?" } %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- Order Summary Sidebar -->
    <div class="col-lg-4">
      <div class="card position-sticky" style="top: 20px;">
        <div class="card-header">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
            <span>Items (<%= @cart.total_items %>):</span>
            <span>$<%= sprintf("%.2f", @order_summary[:subtotal]) %></span>
          </div>
          <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
            <span>Shipping:</span>
            <span>
              <% if @order_summary[:shipping_cost] == 0 %>
                FREE
              <% else %>
                $<%= sprintf("%.2f", @order_summary[:shipping_cost]) %>
              <% end %>
            </span>
          </div>
          <div class="d-flex justify-content-between border-bottom pb-2 mb-3">
            <span>Tax:</span>
            <span>$<%= sprintf("%.2f", @order_summary[:tax_amount]) %></span>
          </div>
          <div class="d-flex justify-content-between">
            <strong>Total:</strong>
            <strong class="text-primary">$<%= sprintf("%.2f", @order_summary[:total]) %></strong>
          </div>
          
          <div class="mt-3 pt-3 border-top">
            <small class="text-muted">
              <i class="fas fa-shield-alt me-1"></i>
              Your payment information is secure and encrypted
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>