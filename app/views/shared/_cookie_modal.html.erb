<!-- Cookie Preferences Modal (Always Rendered) -->
<div id="cookieModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeCookieModalOnBackdrop(event)">
  <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
    <!-- Modal Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
      <h5 class="text-xl font-semibold text-charcoal">Cookie Preferences</h5>
      <button type="button" class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeCookieModal()" aria-label="Close">
        <%= heroicon "x-mark", variant: :outline, class: "w-6 h-6" %>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <p class="text-gray-600 mb-6">
        We use different types of cookies to optimize your experience. Click on the categories below to learn more
        and change your preferences. Note that blocking some types of cookies may impact your experience.
      </p>

      <!-- Essential Cookies -->
      <div class="mb-6">
        <div class="flex items-start gap-3">
          <div class="flex items-center h-6">
            <input type="checkbox" id="essentialCookies" checked disabled class="h-4 w-4 text-bio-green border-gray-300 rounded focus:ring-bio-green disabled:opacity-50">
          </div>
          <div class="flex-grow">
            <label for="essentialCookies" class="block">
              <span class="text-charcoal font-semibold">Essential Cookies</span>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-500 text-white ml-2">Always Active</span>
            </label>
            <p class="text-gray-600 text-sm mt-1">
              These cookies are necessary for the website to function and cannot be switched off.
              They are usually set in response to actions you take, like signing in or filling in forms.
            </p>
          </div>
        </div>
      </div>

      <!-- Analytics Cookies -->
      <div class="mb-6">
        <div class="flex items-start gap-3">
          <div class="flex items-center h-6">
            <input type="checkbox" id="analyticsCookies" class="h-4 w-4 text-bio-green border-gray-300 rounded focus:ring-bio-green">
          </div>
          <div class="flex-grow">
            <label for="analyticsCookies" class="block">
              <span class="text-charcoal font-semibold">Analytics Cookies</span>
            </label>
            <p class="text-gray-600 text-sm mt-1">
              These cookies help us understand how visitors interact with our website by collecting
              and reporting information anonymously. This helps us improve our service.
            </p>
          </div>
        </div>
      </div>

      <!-- Marketing Cookies -->
      <div class="mb-6">
        <div class="flex items-start gap-3">
          <div class="flex items-center h-6">
            <input type="checkbox" id="marketingCookies" class="h-4 w-4 text-bio-green border-gray-300 rounded focus:ring-bio-green">
          </div>
          <div class="flex-grow">
            <label for="marketingCookies" class="block">
              <span class="text-charcoal font-semibold">Marketing Cookies</span>
            </label>
            <p class="text-gray-600 text-sm mt-1">
              These cookies are used to track visitors across websites to display ads that are
              relevant and engaging for individual users.
            </p>
          </div>
        </div>
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
        <%= heroicon "information-circle", variant: :outline, class: "text-blue-600 w-5 h-5 flex-shrink-0 mt-0.5" %>
        <p class="text-gray-700 text-sm">
          You can change your preferences at any time by clicking the "Cookie Settings" link in the footer.
        </p>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="flex flex-col sm:flex-row gap-3 px-6 py-4 border-t border-gray-200">
      <button type="button" class="inline-flex items-center justify-center px-6 py-2 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors" onclick="closeCookieModal()">
        Cancel
      </button>
      <button type="button" class="inline-flex items-center justify-center px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors" onclick="savePreferences()">
        Save Preferences
      </button>
    </div>
  </div>
</div>

<script>
  // Cookie modal functions - always available
  function acceptAll() {
    updateConsent(true, true, true);
  }

  function rejectAll() {
    updateConsent(true, false, false);
  }

  function manageCookies() {
    const modal = document.getElementById('cookieModal');
    if (modal) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeCookieModal() {
    const modal = document.getElementById('cookieModal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  function closeCookieModalOnBackdrop(event) {
    if (event.target.id === 'cookieModal') {
      closeCookieModal();
    }
  }

  function savePreferences() {
    const analytics = document.getElementById('analyticsCookies').checked;
    const marketing = document.getElementById('marketingCookies').checked;
    updateConsent(true, analytics, marketing);
    closeCookieModal();
  }

  function updateConsent(essential, analytics, marketing) {
    fetch('/cookies/consent', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        essential: essential,
        analytics: analytics,
        marketing: marketing
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const banner = document.getElementById('cookieBanner');
        if (banner) {
          banner.style.display = 'none';
        }
        // Reload page to apply new cookie settings
        window.location.reload();
      }
    })
    .catch(error => {
      console.error('Error updating cookie consent:', error);
    });
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeCookieModal();
    }
  });
</script>
